<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PETè‹±è¯­å±‹è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .section.success {
            border-left-color: #27ae60;
        }

        .section.error {
            border-left-color: #e74c3c;
        }

        .section.warning {
            border-left-color: #f39c12;
        }

        button {
            padding: 12px 24px;
            margin: 10px 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 13px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ” PETè‹±è¯­å±‹è¯Šæ–­å·¥å…·</h1>

        <div class="section">
            <h3>ğŸ“Š ç³»ç»Ÿæ£€æŸ¥</h3>
            <button class="btn-primary" onclick="runDiagnostics()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <div id="diagnosticResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>ğŸ’¾ æ•°æ®æ¢å¤</h3>
            <button class="btn-success" onclick="restoreData()">æ¢å¤å†…ç½®æ•°æ®</button>
            <div id="restoreResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>ğŸ—‘ï¸ æ¸…é™¤æ•°æ®</h3>
            <button class="btn-danger" onclick="clearData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
            <div id="clearResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script src="src/pet-content.js"></script>
    <script>
        function showResult(elementId, text, type = '') {
            const result = document.getElementById(elementId);
            result.style.display = 'block';
            result.className = 'result';
            result.textContent = text;
        }

        function runDiagnostics() {
            const result = [];
            result.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            result.push('ğŸ” PETè‹±è¯­å±‹è¯Šæ–­æŠ¥å‘Š');
            result.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

            // 1. æ£€æŸ¥å†…ç½®æ•°æ®
            result.push('1ï¸âƒ£ æ£€æŸ¥å†…ç½®æ•°æ® (window.petContent)');
            if (window.petContent) {
                result.push('   âœ… window.petContent å­˜åœ¨');
                result.push(`   ğŸ“Š å†…ç½®æ•°æ®ç»Ÿè®¡:`);
                result.push(`      - å•è¯: ${window.petContent.vocab?.length || 0} ä¸ª`);
                result.push(`      - é˜…è¯»: ${window.petContent.readingSets?.length || 0} é¢˜`);
                result.push(`      - å›ºå®šæ­é…: ${window.petContent.collocationSets?.length || 0} é¢˜`);
                result.push(`      - å®Œå½¢: ${window.petContent.clozeSets?.length || 0} é¢˜`);
            } else {
                result.push('   âŒ window.petContent ä¸å­˜åœ¨');
                result.push('   âš ï¸ å¯èƒ½åŸå› : src/pet-content.js æ–‡ä»¶æœªåŠ è½½');
            }
            result.push('');

            // 2. æ£€æŸ¥localStorageæ•°æ®
            result.push('2ï¸âƒ£ æ£€æŸ¥ localStorage æ•°æ®');
            const keys = ['petEnglishData', 'petEnglishData_backup', 'petEnglishData_old', 'petData'];
            let foundData = false;

            for (const key of keys) {
                const data = localStorage.getItem(key);
                if (data) {
                    foundData = true;
                    try {
                        const parsed = JSON.parse(data);
                        result.push(`   âœ… æ‰¾åˆ°æ•°æ®é”®: ${key}`);
                        result.push(`   ğŸ“Š æ•°æ®ç»Ÿè®¡:`);
                        result.push(`      - å•è¯: ${parsed.vocab?.length || 0} ä¸ª`);
                        result.push(`      - é˜…è¯»: ${parsed.readingSets?.length || 0} é¢˜`);
                        result.push(`      - å›ºå®šæ­é…: ${parsed.collocationSets?.length || 0} é¢˜`);
                        result.push(`      - å®Œå½¢: ${parsed.clozeSets?.length || 0} é¢˜`);
                        result.push(`      - æ•°æ®å¤§å°: ${(data.length / 1024).toFixed(2)} KB`);
                    } catch (e) {
                        result.push(`   âŒ ${key} æ•°æ®è§£æå¤±è´¥: ${e.message}`);
                    }
                    break;
                }
            }

            if (!foundData) {
                result.push('   âš ï¸ æ²¡æœ‰æ‰¾åˆ°ä»»ä½• localStorage æ•°æ®');
                result.push('   ğŸ’¡ å»ºè®®: ç‚¹å‡»"æ¢å¤å†…ç½®æ•°æ®"æŒ‰é’®');
            }
            result.push('');

            // 3. æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
            result.push('3ï¸âƒ£ æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥');
            result.push(`   User Agent: ${navigator.userAgent}`);
            result.push(`   LocalStorage æ”¯æŒ: ${typeof Storage !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            result.push(`   JSON æ”¯æŒ: ${typeof JSON !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            result.push('');

            // 4. è¯Šæ–­ç»“æœ
            result.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            result.push('ğŸ“‹ è¯Šæ–­å»ºè®®:');

            if (!window.petContent) {
                result.push('   âŒ å†…ç½®æ•°æ®æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ src/pet-content.js æ–‡ä»¶');
            } else if (!foundData) {
                result.push('   âš ï¸ localStorage ä¸­æ²¡æœ‰æ•°æ®ï¼Œå»ºè®®æ¢å¤å†…ç½®æ•°æ®');
            } else {
                result.push('   âœ… ç³»ç»Ÿæ­£å¸¸ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨');
            }

            result.push('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            showResult('diagnosticResult', result.join('\n'));
        }

        function restoreData() {
            try {
                setTimeout(() => {
                    if (!window.petContent) {
                        showResult('restoreResult', 'âŒ å†…ç½®æ•°æ®åŠ è½½å¤±è´¥\n\næ— æ³•æ‰¾åˆ° window.petContent å¯¹è±¡ã€‚\nè¯·ç¡®ä¿ src/pet-content.js æ–‡ä»¶å­˜åœ¨ä¸”æ­£ç¡®åŠ è½½ã€‚');
                        return;
                    }

                    const builtInData = {
                        vocab: window.petContent.vocab || [],
                        readingSets: window.petContent.readingSets || [],
                        collocationSets: window.petContent.collocationSets || [],
                        clozeSets: window.petContent.clozeSets || []
                    };

                    const stats = {
                        'å•è¯': builtInData.vocab.length,
                        'é˜…è¯»': builtInData.readingSets.length,
                        'å›ºå®šæ­é…': builtInData.collocationSets.length,
                        'å®Œå½¢': builtInData.clozeSets.length
                    };

                    // ä¿å­˜åˆ°å¤šä¸ªä½ç½®
                    const saveKeys = ['petEnglishData', 'petEnglishData_backup', 'petEnglishData_old', 'petData'];
                    saveKeys.forEach(key => {
                        try {
                            localStorage.setItem(key, JSON.stringify(builtInData));
                        } catch (e) {
                            console.warn(`ä¿å­˜åˆ° ${key} å¤±è´¥:`, e);
                        }
                    });

                    showResult('restoreResult', `âœ… æ•°æ®æ¢å¤æˆåŠŸï¼\n\næ¢å¤ç»Ÿè®¡:\n${JSON.stringify(stats, null, 2)}\n\næ•°æ®å¤§å°: ${(JSON.stringify(builtInData).length / 1024).toFixed(2)} KB\n\nç°åœ¨å¯ä»¥æ‰“å¼€ src/index.html æŸ¥çœ‹æ¢å¤åçš„æ•°æ®ã€‚`);
                }, 500);
            } catch (e) {
                showResult('restoreResult', `âŒ æ¢å¤å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ${e.message}`);
            }
        }

        function clearData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ localStorage æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                try {
                    const keys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('pet')) {
                            keys.push(key);
                        }
                    }

                    keys.forEach(key => {
                        localStorage.removeItem(key);
                    });

                    showResult('clearResult', `âœ… å·²æ¸…é™¤æ‰€æœ‰ PET ç›¸å…³æ•°æ®\n\næ¸…é™¤çš„é”®:\n${keys.join('\n')}\n\nå…± ${keys.length} ä¸ªé”®\n\nç°åœ¨å¯ä»¥ç‚¹å‡»"æ¢å¤å†…ç½®æ•°æ®"æ¥é‡æ–°åŠ è½½æ•°æ®ã€‚`);
                } catch (e) {
                    showResult('clearResult', `âŒ æ¸…é™¤å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ${e.message}`);
                }
            } else {
                showResult('clearResult', 'âŒ å·²å–æ¶ˆæ¸…é™¤æ“ä½œ');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.onload = () => {
            runDiagnostics();
        };
    </script>
</body>

</html>