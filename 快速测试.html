<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PETåº”ç”¨å¿«é€Ÿæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            max-width: 800px;
            margin: 30px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” PETè‹±è¯­å±‹å¿«é€Ÿæµ‹è¯•</h1>

    <div class="card">
        <h2>ğŸ“ æ–‡ä»¶æ£€æŸ¥</h2>
        <div id="fileCheck" class="status info">æ­£åœ¨æ£€æŸ¥...</div>
    </div>

    <div class="card">
        <h2>ğŸ“¦ å†…ç½®æ•°æ®æ£€æŸ¥</h2>
        <div id="builtinData" class="status info">æ­£åœ¨æ£€æŸ¥...</div>
    </div>

    <div class="card">
        <h2>ğŸ’¾ LocalStorage æ•°æ®æ£€æŸ¥</h2>
        <div id="localStorageData" class="status info">æ­£åœ¨æ£€æŸ¥...</div>
    </div>

    <div class="card">
        <h2>ğŸ§ª JavaScript è¯­æ³•æ£€æŸ¥</h2>
        <div id="jsCheck" class="status info">æ­£åœ¨æ£€æŸ¥...</div>
    </div>

    <div class="card">
        <h2>âš¡ å¿«é€Ÿæ“ä½œ</h2>
        <button onclick="restoreData()">ğŸ”„ æ¢å¤æ•°æ®</button>
        <button onclick="openApp()">ğŸš€ æ‰“å¼€åº”ç”¨</button>
        <button onclick="checkAll()">ğŸ” é‡æ–°æ£€æŸ¥</button>
    </div>

    <div class="card">
        <h2>ğŸ“Š è¯¦ç»†æ—¥å¿—</h2>
        <pre id="log">ç­‰å¾…æ£€æŸ¥...</pre>
    </div>

    <script src="src/pet-content.js"></script>
    <script>
        let logMessages = [];

        function log(msg) {
            logMessages.push(msg);
            document.getElementById('log').textContent = logMessages.join('\n');
            console.log(msg);
        }

        function updateStatus(id, text, type) {
            const el = document.getElementById(id);
            el.textContent = text;
            el.className = 'status ' + type;
        }

        async function checkFiles() {
            log('ğŸ“ å¼€å§‹æ£€æŸ¥æ–‡ä»¶...');
            const files = [
                'src/index.html',
                'src/pet-content.js'
            ];

            try {
                const response = await fetch('src/index.html', { method: 'HEAD' });
                if (response.ok) {
                    updateStatus('fileCheck', 'âœ… src/index.html å­˜åœ¨', 'success');
                    log('âœ… src/index.html å¯ä»¥è®¿é—®');
                } else {
                    updateStatus('fileCheck', 'âŒ src/index.html ä¸å­˜åœ¨', 'error');
                    log('âŒ src/index.html æ— æ³•è®¿é—®');
                }

                const response2 = await fetch('src/pet-content.js', { method: 'HEAD' });
                if (response2.ok) {
                    log('âœ… src/pet-content.js å¯ä»¥è®¿é—®');
                } else {
                    log('âŒ src/pet-content.js æ— æ³•è®¿é—®');
                }
            } catch (e) {
                updateStatus('fileCheck', 'âš ï¸ æ— æ³•æ£€æŸ¥æ–‡ä»¶: ' + e.message, 'warning');
                log('âš ï¸ æ–‡ä»¶æ£€æŸ¥å¤±è´¥: ' + e.message);
            }
        }

        function checkBuiltinData() {
            log('ğŸ“¦ æ£€æŸ¥å†…ç½®æ•°æ®...');
            if (window.petContent) {
                const stats = {
                    å•è¯: window.petContent.vocab?.length || 0,
                    é˜…è¯»: window.petContent.readingSets?.length || 0,
                    å›ºå®šæ­é…: window.petContent.collocationSets?.length || 0,
                    å®Œå½¢: window.petContent.clozeSets?.length || 0
                };
                const total = stats.å•è¯ + stats.é˜…è¯» + stats.å›ºå®šæ­é… + stats.å®Œå½¢;
                updateStatus('builtinData', `âœ… å†…ç½®æ•°æ®å­˜åœ¨ (å…± ${total} æ¡): ${JSON.stringify(stats)}`, 'success');
                log('âœ… å†…ç½®æ•°æ®: ' + JSON.stringify(stats));
            } else {
                updateStatus('builtinData', 'âŒ å†…ç½®æ•°æ®æœªåŠ è½½ (window.petContent ä¸å­˜åœ¨)', 'error');
                log('âŒ window.petContent æœªå®šä¹‰');
            }
        }

        function checkLocalStorage() {
            log('ğŸ’¾ æ£€æŸ¥ LocalStorage...');
            const keys = ['petEnglishData', 'petEnglishData_backup', 'petEnglishData_old', 'petData'];
            let found = false;
            let totalItems = 0;

            for (const key of keys) {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        const count = (parsed.vocab?.length || 0) +
                                     (parsed.readingSets?.length || 0) +
                                     (parsed.collocationSets?.length || 0) +
                                     (parsed.clozeSets?.length || 0);
                        log(`âœ… æ‰¾åˆ° ${key}: ${count} æ¡æ•°æ®`);
                        totalItems += count;
                        found = true;
                    } catch (e) {
                        log(`âš ï¸ ${key} æ•°æ®æŸå`);
                    }
                }
            }

            if (found) {
                updateStatus('localStorageData', `âœ… LocalStorage ä¸­æœ‰æ•°æ® (å…± ${totalItems} æ¡)`, 'success');
            } else {
                updateStatus('localStorageData', 'âš ï¸ LocalStorage ä¸­æ²¡æœ‰æ•°æ®', 'warning');
                log('âš ï¸ LocalStorage ä¸ºç©º');
            }
        }

        async function checkJavaScript() {
            log('ğŸ§ª æ£€æŸ¥ JavaScript è¯­æ³•...');
            try {
                const response = await fetch('src/index.html');
                const html = await response.text();

                // æ£€æŸ¥å…³é”®å‡½æ•°æ˜¯å¦å­˜åœ¨
                const scriptContent = html.match(/<script>([\s\S]*)<\/script>/);
                if (scriptContent) {
                    const requiredFunctions = [
                        'loadWord',
                        'loadReading',
                        'loadCollocation',
                        'loadCloze',
                        'showDictModal',
                        'closeDictModal'
                    ];

                    let missing = [];
                    for (const fn of requiredFunctions) {
                        if (!scriptContent[1].includes('function ' + fn) &&
                            !scriptContent[1].includes(fn + ' =') &&
                            !scriptContent[1].includes(fn + ':')) {
                            missing.push(fn);
                        }
                    }

                    if (missing.length === 0) {
                        updateStatus('jsCheck', 'âœ… æ‰€æœ‰å…³é”®å‡½æ•°éƒ½å­˜åœ¨', 'success');
                        log('âœ… JavaScript æ£€æŸ¥é€šè¿‡');
                    } else {
                        updateStatus('jsCheck', `âš ï¸ ç¼ºå°‘å‡½æ•°: ${missing.join(', ')}`, 'warning');
                        log('âš ï¸ ç¼ºå°‘å‡½æ•°: ' + missing.join(', '));
                    }

                    // æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§
                    if (html.endsWith('</html>')) {
                        log('âœ… HTML æ–‡ä»¶å®Œæ•´é—­åˆ');
                    } else {
                        log('âŒ HTML æ–‡ä»¶æœªæ­£ç¡®é—­åˆ');
                    }
                }
            } catch (e) {
                updateStatus('jsCheck', 'âŒ æ£€æŸ¥å¤±è´¥: ' + e.message, 'error');
                log('âŒ æ£€æŸ¥å¤±è´¥: ' + e.message);
            }
        }

        function restoreData() {
            if (!window.petContent) {
                alert('âŒ å†…ç½®æ•°æ®æœªåŠ è½½ï¼Œæ— æ³•æ¢å¤');
                return;
            }

            const builtInData = {
                vocab: window.petContent.vocab || [],
                readingSets: window.petContent.readingSets || [],
                collocationSets: window.petContent.collocationSets || [],
                clozeSets: window.petContent.clozeSets || []
            };

            localStorage.setItem('petEnglishData', JSON.stringify(builtInData));
            localStorage.setItem('petEnglishData_backup', JSON.stringify(builtInData));

            alert('âœ… æ•°æ®å·²æ¢å¤ï¼å…± ' +
                (builtInData.vocab.length + builtInData.readingSets.length +
                 builtInData.collocationSets.length + builtInData.clozeSets.length) +
                ' æ¡æ•°æ®');

            checkAll();
        }

        function openApp() {
            window.location.href = 'src/index.html';
        }

        async function checkAll() {
            logMessages = [];
            log('ğŸ” å¼€å§‹å…¨é¢æ£€æŸ¥...\n');
            await checkFiles();
            checkBuiltinData();
            checkLocalStorage();
            await checkJavaScript();
            log('\nâœ… æ£€æŸ¥å®Œæˆï¼');
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨æ£€æŸ¥
        window.onload = () => {
            setTimeout(checkAll, 500);
        };
    </script>
</body>
</html>
